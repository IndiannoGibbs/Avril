<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>A.V.R.I.L ‚Äî Audio Reactive UI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app-frame">
      <header class="brand">
        <span class="brand-mark">A.V.R.I.L</span>
        <span class="brand-status" id="brandStatus">Initializing‚Ä¶</span>
      </header>

      <main class="viewport">
        <div class="hud">
          <div class="hud-card">
            <span class="label">Status</span>
            <span class="value" id="micStatus">Calibrating</span>
          </div>
          <div class="hud-card meter">
            <span class="label">Signal</span>
            <div class="meter-track">
              <div class="meter-bar" id="signalBar"></div>
            </div>
          </div>
          <div class="hud-card" id="networkStatus" style="min-width: 80px;">
            <span class="label">Network</span>
            <span class="value" id="networkStatusText">Online</span>
          </div>
          <div class="hud-card" id="alarmIndicator" hidden>
            <span class="label">Alarm</span>
            <span class="value" id="alarmTimeDisplay">--:-- --</span>
          </div>
        </div>

        <div id="orbWrap">
          <div id="orbCanvas"></div>
        </div>

        <div class="voice-viz">
          <span id="listeningStatus" class="listening-status"></span>
          <div id="responseDisplay" class="response-display" hidden>
            <span id="responseText" class="response-text"></span>
          </div>
          <div class="voice-bars">
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
            <span class="voice-bar"></span>
          </div>
        </div>

        <div id="weatherDisplay" class="weather-display" hidden>
          <div class="weather-card">
            <div class="weather-header">
              <span class="weather-location" id="weatherLocation">Location</span>
              <button class="weather-close" id="weatherClose" aria-label="Close weather">√ó</button>
            </div>
            <div class="weather-main">
              <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
              <div class="weather-temp">
                <span class="weather-temp-value" id="weatherTemp">--</span>
                <span class="weather-temp-unit">¬∞C</span>
              </div>
              <div class="weather-condition" id="weatherCondition">Clear</div>
            </div>
            <div class="weather-details">
              <div class="weather-detail">
                <span class="weather-detail-label">Feels like</span>
                <span class="weather-detail-value" id="weatherFeels">--¬∞C</span>
              </div>
              <div class="weather-detail">
                <span class="weather-detail-label">Humidity</span>
                <span class="weather-detail-value" id="weatherHumidity">--%</span>
              </div>
            </div>
          </div>
        </div>

        <div id="reminderDisplay" class="reminder-display" hidden>
          <div class="reminder-card">
            <div class="reminder-header">
              <span class="reminder-icon">‚è∞</span>
              <span class="reminder-title" id="reminderTitle">Reminder</span>
              <button class="reminder-close" id="reminderClose" aria-label="Close reminder">√ó</button>
            </div>
            <div class="reminder-content">
              <div class="reminder-text" id="reminderText">Reminder text</div>
              <div class="reminder-time" id="reminderTime">Time</div>
            </div>
          </div>
        </div>

        <div id="remindersListDisplay" class="reminders-list-display" hidden>
          <div class="reminders-list-card">
            <div class="reminders-list-header">
              <span class="reminders-list-icon">üìã</span>
              <span class="reminders-list-title">Reminders List</span>
              <button class="reminders-list-close" id="remindersListClose" aria-label="Close reminders list">√ó</button>
            </div>
            <div class="reminders-list-content" id="remindersListContent">
              <!-- Reminders will be dynamically inserted here -->
            </div>
          </div>
        </div>

        <div id="timerDisplay" class="timer-display" hidden>
          <div class="timer-card">
            <div class="timer-header">
              <span class="timer-icon">‚è±Ô∏è</span>
              <span class="timer-title">Timer</span>
              <button class="timer-close" id="timerClose" aria-label="Close timer">√ó</button>
            </div>
            <div class="timer-content">
              <div class="timer-time" id="timerTime">00:00:00</div>
              <div class="timer-status" id="timerStatus">Stopped</div>
            </div>
          </div>
        </div>
      </main>

      <div id="ui">
        <button id="startBtn" class="mic idle" aria-label="Start microphone" title="Start microphone">
          <!-- Microphone SVG icon -->
          <svg id="micIcon" width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 14C13.6569 14 15 12.6569 15 11V5C15 3.34315 13.6569 2 12 2C10.3431 2 9 3.34315 9 5V11C9 12.6569 10.3431 14 12 14Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M19 11C19 14.3137 16.3137 17 13 17H11C7.68629 17 5 14.3137 5 11" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M12 17V21" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          <span class="mic-label">Mic</span>
        </button>
        <div class="settings">
          <button id="settingsBtn" class="settings-btn" type="button" aria-haspopup="true" aria-expanded="false">
            Settings
          </button>
        </div>
      </div>
      <div id="settingsPanel" class="settings-panel" hidden>
        <button id="closeSettingsBtn" class="close-settings-btn" type="button" aria-label="Close settings">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <label class="range">
          <span>Sensitivity</span>
          <input id="sensitivity" type="range" min="0" max="4" step="0.01" value="1" />
        </label>
        <label class="range">
          <span>Speak time every</span>
          <select id="timeIntervalSelect">
            <option value="1">1 minute (default)</option>
            <option value="5">5 minutes</option>
            <option value="10">10 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">60 minutes</option>
          </select>
        </label>
        <aside class="command-list" aria-label="Voice command list">
          <div class="command-list-title">Commands</div>
          <ul class="command-list-items">
            <li><span class="kw">Hello</span> / <span class="kw">Hey Avril</span> / <span class="kw">Wake up</span> ‚Äî wake A.V.R.I.L</li>
            <li><span class="kw">What time is it?</span></li>
            <li><span class="kw">What is the date today?</span></li>
            <li><span class="kw">What is the weather in [city]?</span></li>
            <li><span class="kw">And tomorrow?</span> / <span class="kw">What about tomorrow?</span> ‚Äî follow-up weather questions</li>
            <li><span class="kw">Set alarm for [time]</span> ‚Äî e.g., "Set alarm for 7:30 AM"</li>
            <li><span class="kw">Stop alarm</span> / <span class="kw">Stop the alarm</span></li>
            <li><span class="kw">Cancel alarm</span> / <span class="kw">Delete alarm</span> / <span class="kw">Clear alarm</span></li>
            <li><span class="kw">Snooze</span> / <span class="kw">Snooze alarm</span> ‚Äî snooze for 5 minutes</li>
            <li><span class="kw">Remind me to [task] at [time]</span> ‚Äî e.g., "Remind me to call mom at 3 PM"</li>
            <li><span class="kw">List reminders</span> / <span class="kw">Show reminders</span></li>
            <li><span class="kw">Tell me a joke</span> / <span class="kw">Joke</span></li>
            <li><span class="kw">Mute</span> / <span class="kw">Mute mic</span> / <span class="kw">Mute microphone</span></li>
            <li><span class="kw">Unmute</span> / <span class="kw">Unmute mic</span> / <span class="kw">Unmute microphone</span></li>
            <li><span class="kw">Show commands</span> / <span class="kw">Open commands</span></li>
            <li><span class="kw">Close command list</span> / <span class="kw">Close commands</span> / <span class="kw">Hide command list</span></li>
            <li><span class="kw">Command list</span> / <span class="kw">List of commands</span> ‚Äî hear commands</li>
          </ul>
          <div class="command-create">
            <div class="command-create-title">Add command</div>
            <label class="command-field">
              <span>Command phrase</span>
              <input id="customCommandPhrase" type="text" placeholder='e.g. "lights on"' />
            </label>
            <label class="command-field">
              <span>Command response</span>
              <textarea id="customCommandResponse" rows="2" placeholder='e.g. "Turning the lights on."' ></textarea>
            </label>
            <button id="addCommandBtn" type="button">Save</button>
          </div>
        </aside>
      </div>
    </div>

    <div id="sleepScreen" class="sleep-screen" hidden>
      <div class="sleep-clock">
        <div class="clock-time" id="sleepTime">00:00</div>
        <div class="clock-date" id="sleepDate">Monday, 1 January</div>
      </div>
    </div>

    <div id="onScreenKeyboard" class="on-screen-keyboard" hidden>
      <div class="keyboard-container">
        <div class="keyboard-row">
          <button class="keyboard-key" data-key="q">Q</button>
          <button class="keyboard-key" data-key="w">W</button>
          <button class="keyboard-key" data-key="e">E</button>
          <button class="keyboard-key" data-key="r">R</button>
          <button class="keyboard-key" data-key="t">T</button>
          <button class="keyboard-key" data-key="y">Y</button>
          <button class="keyboard-key" data-key="u">U</button>
          <button class="keyboard-key" data-key="i">I</button>
          <button class="keyboard-key" data-key="o">O</button>
          <button class="keyboard-key" data-key="p">P</button>
        </div>
        <div class="keyboard-row">
          <button class="keyboard-key" data-key="a">A</button>
          <button class="keyboard-key" data-key="s">S</button>
          <button class="keyboard-key" data-key="d">D</button>
          <button class="keyboard-key" data-key="f">F</button>
          <button class="keyboard-key" data-key="g">G</button>
          <button class="keyboard-key" data-key="h">H</button>
          <button class="keyboard-key" data-key="j">J</button>
          <button class="keyboard-key" data-key="k">K</button>
          <button class="keyboard-key" data-key="l">L</button>
        </div>
        <div class="keyboard-row">
          <button class="keyboard-key keyboard-key-wide" data-key="shift">Shift</button>
          <button class="keyboard-key" data-key="z">Z</button>
          <button class="keyboard-key" data-key="x">X</button>
          <button class="keyboard-key" data-key="c">C</button>
          <button class="keyboard-key" data-key="v">V</button>
          <button class="keyboard-key" data-key="b">B</button>
          <button class="keyboard-key" data-key="n">N</button>
          <button class="keyboard-key" data-key="m">M</button>
          <button class="keyboard-key keyboard-key-wide" data-key="backspace">‚å´</button>
        </div>
        <div class="keyboard-row">
          <button class="keyboard-key" data-key="1">1</button>
          <button class="keyboard-key" data-key="2">2</button>
          <button class="keyboard-key" data-key="3">3</button>
          <button class="keyboard-key" data-key="4">4</button>
          <button class="keyboard-key" data-key="5">5</button>
          <button class="keyboard-key" data-key="6">6</button>
          <button class="keyboard-key" data-key="7">7</button>
          <button class="keyboard-key" data-key="8">8</button>
          <button class="keyboard-key" data-key="9">9</button>
          <button class="keyboard-key" data-key="0">0</button>
        </div>
        <div class="keyboard-row">
          <button class="keyboard-key" data-key=" ">Space</button>
          <button class="keyboard-key" data-key=".">.</button>
          <button class="keyboard-key" data-key=",">,</button>
          <button class="keyboard-key" data-key="!">!</button>
          <button class="keyboard-key" data-key="?">?</button>
          <button class="keyboard-key" data-key="'">'</button>
          <button class="keyboard-key" data-key='"'>"</button>
          <button class="keyboard-key keyboard-key-wide" data-key="enter">Enter</button>
        </div>
      </div>
    </div>

    <script>
      // Polyfills for older Android browsers (4.4+)
      (function() {
        // Polyfill for getUserMedia for older Android browsers
        if (!navigator.mediaDevices) {
          navigator.mediaDevices = {};
        }
        
        if (!navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia = function(constraints) {
            var getUserMedia = navigator.getUserMedia || 
                              navigator.webkitGetUserMedia || 
                              navigator.mozGetUserMedia || 
                              navigator.msGetUserMedia;
            
            if (!getUserMedia) {
              return Promise.reject(new Error('getUserMedia is not supported in this browser'));
            }
            
            return new Promise(function(resolve, reject) {
              getUserMedia.call(navigator, constraints, resolve, reject);
            });
          };
        }
        
        // Ensure AudioContext is available with webkit prefix for older browsers
        if (!window.AudioContext && window.webkitAudioContext) {
          window.AudioContext = window.webkitAudioContext;
        }
      })();
      
      // Prefer local Three.js / OrbitControls when available, fall back to CDN.
      (function () {
        function loadScript(src, options) {
          return new Promise((resolve) => {
            const s = document.createElement('script');
            s.src = src;
            if (options && options.type) s.type = options.type;
            s.onload = () => {
              resolve(true);
            };
            s.onerror = (err) => {
              // Only log if it's not a local file (expected to fail)
              if (!src.includes('src/libs/')) {
                console.warn(`Failed to load script from ${src}`);
              }
              resolve(false);
            };
            document.head.appendChild(s);
          });
        }

        async function loadThreeStack() {
          if (window.THREE) return true;

          // Try local copies first (fast for demos/offline)
          const localThreeOk = await loadScript('src/libs/three.min.js');
          if (localThreeOk && window.THREE) {
            await loadScript('src/libs/OrbitControls.js');
            return true;
          }

          // Fall back to multiple CDN options if local files are missing
          const cdnOptions = [
            'https://unpkg.com/three@0.152.2/build/three.min.js',
            'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js'
          ];
          
          let threeLoaded = false;
          for (const cdnUrl of cdnOptions) {
            try {
              const loaded = await loadScript(cdnUrl);
              if (loaded && window.THREE) {
                threeLoaded = true;
                break;
              }
            } catch (e) {
              console.warn(`Failed to load Three.js from ${cdnUrl}:`, e);
              continue;
            }
          }
          
          if (!threeLoaded || !window.THREE) return false;
          
          // Load OrbitControls - try multiple sources
          const controlsOptions = [
            'https://unpkg.com/three@0.152.2/examples/js/controls/OrbitControls.js',
            'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js'
          ];
          
          for (const controlsUrl of controlsOptions) {
            try {
              await loadScript(controlsUrl);
              if (window.THREE && window.THREE.OrbitControls) break;
            } catch (e) {
              console.warn(`Failed to load OrbitControls from ${controlsUrl}:`, e);
            }
          }
          
          // Load postprocessing libraries for Bloom effect
          const postprocessingUrls = [
            'https://unpkg.com/three@0.152.2/examples/js/postprocessing/EffectComposer.js',
            'https://unpkg.com/three@0.152.2/examples/js/postprocessing/RenderPass.js',
            'https://unpkg.com/three@0.152.2/examples/js/postprocessing/UnrealBloomPass.js'
          ];
          
          for (const url of postprocessingUrls) {
            try {
              await loadScript(url);
            } catch (e) {
              console.warn(`Failed to load postprocessing library from ${url}:`, e);
            }
          }
          
          return true;
        }

        (async function bootstrap() {
          const ok = await loadThreeStack();
          if (!ok) {
            console.warn('Failed to load Three.js ‚Äî AVRIL visuals will be disabled. Voice features will still work.');
            // Still load main.js even if Three.js fails - voice features work without it
          }
          // Load main module after Three.js is ready (or failed)
          const mainScriptLoaded = await loadScript('./src/main.js', { type: 'module' });
          if (!mainScriptLoaded) {
            console.error('Failed to load main AVRIL script.');
          }
        })();
      })();
    </script>
  </body>
</html>
